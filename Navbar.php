<?php 
    session_start(); 
?>
<header class="u-clearfix u-header u-palette-1-base u-sticky u-sticky-0d0f u-header" id="sec-5569"><div class="u-clearfix u-sheet u-sheet-1">
      
      <meta itemprop="name" content="Project Nodenium">
      <meta itemprop="description" content="Season 10">
      <meta itemprop="faviconUrl" content="https://projectnodenium.com_favicon.ico">
      <meta itemprop="url" content="https://projectnodenium.com">
      <meta itemprop="embedURL" content="https://projectnodenium.com">
      <meta itemprop="thumbnailUrl" content="https://projectnodenium.com/Profiles/Content/vyruz_3.png">
      <meta itemprop="image" content="https://projectnodenium.com/Profiles/Content/vyruz_3.png">
      <meta itemprop="imageUrl" content="https://projectnodenium.com/Profiles/Content/vyruz_3.png">

      <a href="https://projectnodenium.com/" class="u-align-left u-image u-logo u-image-1" data-image-width="500" data-image-height="500">
        <img src="../images/m.png" class="u-logo-image u-logo-image-1">
      </a>
      <nav class="u-menu u-menu-dropdown u-offcanvas u-menu-1">
        <div class="menu-collapse" style="font-size: 1rem; letter-spacing: 0px;">
          <a class="u-button-style u-custom-left-right-menu-spacing u-custom-padding-bottom u-custom-text-active-color u-custom-text-shadow u-custom-text-shadow-blur u-custom-text-shadow-transparency u-custom-top-bottom-menu-spacing u-nav-link u-text-active-palette-1-base u-text-hover-palette-2-base" href="#">
            <svg class="u-svg-link" viewBox="0 0 24 24"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#menu-hamburger"></use></svg>
            <svg class="u-svg-content" version="1.1" id="menu-hamburger" viewBox="0 0 16 16" x="0px" y="0px" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg"><g><rect y="1" width="16" height="2"></rect><rect y="7" width="16" height="2"></rect><rect y="13" width="16" height="2"></rect></g></svg>
          </a>
        </div>
        <div class="u-custom-menu u-nav-container">
            <ul class="u-nav u-unstyled u-nav-1">
              <li class="u-nav-item"><a class="u-border-3 u-border-active-white u-border-hover-palette-1-light-1 u-border-no-left u-border-no-right u-border-no-top u-button-style u-nav-link u-text-active-white u-text-hover-palette-2-base" href="../" style="padding: 10px 20px; text-shadow: 2px 2px 9px rgba(0,0,0,1);">Home</a></li>
              <li class="u-nav-item"><a class="u-border-3 u-border-active-white u-border-hover-palette-1-light-1 u-border-no-left u-border-no-right u-border-no-top u-button-style u-nav-link u-text-active-white u-text-hover-palette-2-base" href="../Gallery" style="padding: 10px 20px; text-shadow: 2px 2px 9px rgba(0,0,0,1);">Gallery</a></li>
              <li class="u-nav-item"><a class="u-border-3 u-border-active-white u-border-hover-palette-1-light-1 u-border-no-left u-border-no-right u-border-no-top u-button-style u-nav-link u-text-active-white u-text-hover-palette-2-base" style="padding: 10px 20px; text-shadow: 2px 2px 9px rgba(0,0,0,1);" href="../Members">Server</a>
                <div class="u-nav-popup">
                  <ul class="u-h-spacing-20 u-nav u-unstyled u-v-spacing-10 u-nav-2">
                  <li class="u-nav-item">
                    <a class="u-button-style u-nav-link u-white" href="../Members">Members</a>
                  </li>
                  <li class="u-nav-item">
                    <a class="u-button-style u-nav-link u-white" href="../Store">Store</a>
                  </li>
                  <li class="u-nav-item">
                    <a class="u-button-style u-nav-link u-white" href="../History">History</a>
                  </li>
                </ul>
              </div>
            </li>
              <li class="u-nav-item"><a class="u-border-3 u-border-active-white u-border-hover-palette-1-light-1 u-border-no-left u-border-no-right u-border-no-top u-button-style u-nav-link u-text-active-white u-text-hover-palette-2-base" style="padding: 10px 20px; text-shadow: 2px 2px 9px rgba(0,0,0,1);" href="../Client-Resources">Resources</a>
                <div class="u-nav-popup">
                  <ul class="u-h-spacing-20 u-nav u-unstyled u-v-spacing-10 u-nav-2">
                  <li class="u-nav-item">
                    <a class="u-button-style u-nav-link u-white" href="../Client-Resources">Installable Resources</a>
                  </li>
                  <li class="u-nav-item">
                    <a class="u-button-style u-nav-link u-white" href="../Server-Resources">Server Resources</a>
                  </li>
                </ul>
              </div>
            </li>
            <li class="u-nav-item"><a class="u-border-3 u-border-active-white u-border-hover-palette-1-light-1 u-border-no-left u-border-no-right u-border-no-top u-button-style u-nav-link u-text-active-white u-text-hover-palette-2-base" href="../Profiles/Login" style="padding: 10px 20px; text-shadow: 2px 2px 9px rgba(0,0,0,1); display: none;" id="signIn">Sign In</a></li>
            <li class="u-nav-item"><a class="u-border-3 u-border-active-white u-border-hover-palette-1-light-1 u-border-no-left u-border-no-right u-border-no-top u-button-style u-nav-link u-text-active-white u-text-hover-palette-2-base" style="padding: 10px 20px; text-shadow: 2px 2px 9px rgba(0,0,0,1); display: none;" id="profileName" href="../Profiles/Account"><img id="pfpImage" src=""></a>
              <div class="u-nav-popup">
                <ul class="u-h-spacing-20 u-nav u-unstyled u-v-spacing-10 u-nav-2">
                <li class="u-nav-item">
                  <a class="u-button-style u-nav-link u-white" href="../Profiles/Profile?member=<?php echo $_SESSION['username'] ?>">Profile</a>
                </li>
                <li class="u-nav-item">
                  <a class="u-button-style u-nav-link u-white" href="../Profiles/Account">Settings</a>
                </li>
                <li class="u-nav-item">
                  <a class="u-button-style u-nav-link u-white" href="../Profiles/SignOut">Sign Out</a>
                </li>
              </ul>
            </div>
          </li> 
        </ul>
        </div>
          <div class="u-custom-menu u-nav-container-collapse">
            <div class="u-black u-container-style u-inner-container-layout u-opacity u-opacity-95 u-sidenav">
              <div class="u-inner-container-layout u-sidenav-overflow">
                <div class="u-menu-close"></div>
                <ul class="u-align-center u-nav u-popupmenu-items u-unstyled u-nav-3">
                  <li class="u-nav-item"><a class="u-button-style u-nav-link" href="../" style="padding: 10px 20px; text-shadow: 2px 2px 9px rgba(0,0,0,1);">Home</a></li>
                  <li class="u-nav-item"><a class="u-button-style u-nav-link" href="../Gallery" style="padding: 10px 20px; text-shadow: 2px 2px 9px rgba(0,0,0,1);">Gallery</a></li>
                  <li class="u-nav-item"><a class="u-button-style u-nav-link" style="padding: 10px 20px; text-shadow: 2px 2px 9px rgba(0,0,0,1);">Server</a>
                    <div class="u-nav-popup">
                      <ul class="u-h-spacing-20 u-nav u-unstyled u-v-spacing-10 u-nav-4">
                        <li class="u-nav-item"><a class="u-button-style u-nav-link" href="../Members">Members</a></li>
                        <li class="u-nav-item"><a class="u-button-style u-nav-link" href="../Store">Store</a></li>
                        <li class="u-nav-item"><a class="u-button-style u-nav-link" href="../History">History</a></li>
                      </ul>
                    </div>
                  </li>
                  <li class="u-nav-item"><a class="u-button-style u-nav-link" style="padding: 10px 20px; text-shadow: 2px 2px 9px rgba(0,0,0,1);">Resources</a>
                    <div class="u-nav-popup">
                      <ul class="u-h-spacing-20 u-nav u-unstyled u-v-spacing-10 u-nav-4">
                        <li class="u-nav-item"><a class="u-button-style u-nav-link" href="../Client-Resources">Installable Resources</a></li>
                        <li class="u-nav-item"><a class="u-button-style u-nav-link" href="../Server-Resources">Server Resources</a></li>
                      </ul>
                    </div>
                  </li>
                  <li class="u-nav-item"><a class="u-button-style u-nav-link" href="../Profiles/Login" style="padding: 10px 20px; text-shadow: 2px 2px 9px rgba(0,0,0,1); display: none;" id="signIn2">Sign In</a></li>
                  <li class="u-nav-item"><a class="u-button-style u-nav-link" style="padding: 10px 20px; text-shadow: 2px 2px 9px rgba(0,0,0,1); display: none;" id="profileName2" ><img id="pfpImage2" src=""></a>
                    <div class="u-nav-popup">
                      <ul class="u-h-spacing-20 u-nav u-unstyled u-v-spacing-10 u-nav-4">
                        <li class="u-nav-item"><a class="u-button-style u-nav-link" href="../Profiles/Profile?member=<?php echo $_SESSION['username'] ?>">Profile</a></li>
                        <li class="u-nav-item"><a class="u-button-style u-nav-link" href="../Profiles/SignOut">Sign Out</a></li>
                      </ul>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
            <div class="u-black u-menu-overlay u-opacity u-opacity-70"></div>
          </div>
        </nav>
      </div>
  </header>
  <style>
    #pfpImage{
      width:50px; 
      height: auto; 
      display: inline-block;
      border-radius: 5px;
      filter: drop-shadow(2px 2px 9px rgba(0,0,0,1));
      scale: 1;
      transition: 0.2s;
    }
    #pfpImage:hover{
      scale: 1.1;
      transition: 0.2s;
    }

    #pfpImage2{
      width:50px; 
      height: auto; 
      display: inline-block;
      border-radius: 5px;
      filter: drop-shadow(2px 2px 9px rgba(0,0,0,1));
      scale: 1;
      transition: 0.2s;
    }
    #pfpImage2:hover{
      scale: 1.1;
      transition: 0.2s;
    }
  </style>
<?php
  function is_bot(){
    preg_match('/bot|curl|spider|google|twitter^$/i', $_SERVER['HTTP_USER_AGENT'], $matches);

    return (empty($matches)) ? false : true;
  }

  $filepath = "Visitors.json";
  $jsondata = file_get_contents($filepath);
  $json = json_decode($jsondata, true);
  $ip = $_SERVER['REMOTE_ADDR'];

if (!is_bot() && !isset($json['ips'][$ip]['isBot'])) {

  //unique visitor count
  if (!isset($json['ips'][$ip])) {
    $json["totalUniqueVisits"] = $json["totalUniqueVisits"] + 1;
    $json['ips'][$ip]['firstSeen'] = date("Y-m-d") . " " . date("h:i:sa");
    $location = file_get_contents("https://json.geoiplookup.io/".$ip);
    $location = json_decode($location, true);
    $json['ips'][$ip]['location'] = array($location["latitude"], $location["longitude"]);
  }

  //hits are every page loaded
  $json["totalHits"] = $json["totalHits"] + 1;
  if (!isset($json['ips'][$ip]['hits'])) {
    $json['ips'][$ip]['hits'] = 0;
  }
  $json['ips'][$ip]['hits'] = $json['ips'][$ip]['hits'] + 1;
  $json['ips'][$ip]['lastSeen'] = date("Y-m-d") . " " . date("h:i:sa");

  $hour = date("H");
  $json['visitsByHour'][$hour]++;
  $date = date("Y-m-d");
  if (!isset($json['visitsByDate'][$date])) {
    $json['visitsByDate'][$date] = 0;
  }
  $json['visitsByDate'][$date]++;


  //log the page
  $currentPage = $_SERVER['REQUEST_URI'];
  if (!isset($json['ips'][$ip]['pages'][$currentPage])) {
    $json['ips'][$ip]['pages'][$currentPage] = 0;
  }
  $json['ips'][$ip]['pages'][$currentPage] = $json['ips'][$ip]['pages'][$currentPage] + 1;
  $json['totalPages'][$currentPage] = $json['totalPages'][$currentPage] + 1;

  //log where they came from (if they came from another page)
  if (isset($_SERVER['HTTP_REFERER'])) {
    $referer = $_SERVER['HTTP_REFERER'];
    if (strpos($referer . '', 'projectnodenium.com') == false) {
      if (!isset($json['ips'][$ip]['referrers'][$referer])) {
        $json['ips'][$ip]['referrers'][$referer] = 0;
      }
      $json['ips'][$ip]['referrers'][$referer] = $json['ips'][$ip]['referrers'][$referer] + 1;
      $json['totalReferrers'][$referer] = $json['totalReferrers'][$referer] + 1;
    }
  }

  //visits are every unique session
  if (!isset($_SESSION['visitID'])) {
    if (!isset($json['ips'][$ip]['visits'])) {
      $json['ips'][$ip]['visits'] = 0;
    }
    $json['ips'][$ip]['visits'] = $json['ips'][$ip]['visits'] + 1;
    $json["totalVisits"] = $json["totalVisits"] + 1;
  }
}

  if(isset($_SESSION['username']) && htmlspecialchars($_SESSION['username']) !='')
  {
    $path = json_decode(file_get_contents(__DIR__."/Profiles/ProfileDatas/" . htmlspecialchars($_SESSION['username']) . "_profile.json"), true)['path'];
    $pfpSrc = "../Profiles/PFPs/".$path."_pfp.png";
    echo '<script type="text/javascript">
            document.getElementById("profileName").style.display = "block";
            document.getElementById("signIn").style.display = "none";
            document.getElementById("pfpImage").src = "'.$pfpSrc.'";

            document.getElementById("profileName2").style.display = "block";
            document.getElementById("signIn2").style.display = "none";
            document.getElementById("pfpImage2").src = "'.$pfpSrc.'";
          </script>';

  }else{
    echo '<script type="text/javascript">
            document.getElementById("signIn").style.display = "block";
            document.getElementById("profileName").style.display = "none";

            document.getElementById("signIn2").style.display = "block";
            document.getElementById("profileName2").style.display = "none";
          </script>';
        

          if(isset($_COOKIE['username']) && htmlspecialchars($_COOKIE['username']) != '')
          {
            if(isset($_COOKIE['loginToken']) && htmlspecialchars($_COOKIE['loginToken']) != '')
            {
              $username = htmlspecialchars($_COOKIE['username']);
              $namehash = hash('sha256', $username);
              $remember = json_decode(file_get_contents(__DIR__."/Profiles/RememberMe.json"), true);

              if(isset($remember[$namehash]['loginToken']) && $remember[$namehash]['loginToken'] == htmlspecialchars($_COOKIE['loginToken']))
              {
                $_SESSION['username'] = $username;

                if(!isset($json['ips'][$ip]['logins'])){
                  $json['ips'][$ip]['logins'] = 0;
                }
                $json['ips'][$ip]['logins'] = $json['ips'][$ip]['logins'] + 1;
                $json["totalLogins"] = $json["totalLogins"] + 1;
                //add usernmame to json
                if(!isset($json['ips'][$ip]['usernames'][$username])){
                  $json['ips'][$ip]['usernames'][$username] = 0;
                }
                $json['ips'][$ip]['usernames'][$username] = $json['ips'][$ip]['usernames'][$username] + 1;

                echo '<script type="text/javascript">window.location.href = window.location.href;</script>';
              }else{
                setcookie("username", "", time() - 3600, "/");
                setcookie("loginToken", "", time() - 3600, "/");
                echo '<script> console.log("Invalid login token"); </script>';
              }
            }else{
              echo '<script> console.log("No login token set"); </script>';
            }
          }else{
            echo '<script> console.log("No username cookie set"); </script>';
          }
  }

  $jsondata = json_encode($json, JSON_PRETTY_PRINT);
  file_put_contents($filepath, $jsondata);

  $_SESSION['visitID'] = $_SERVER['REMOTE_ADDR'];


?>